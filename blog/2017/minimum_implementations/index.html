<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Minimum implementations | Josh Peterson </title> <meta name="author" content="Josh Peterson"> <meta name="description" content="Josh's personal website "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%8B&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://joshpeterson.github.io/blog/2017/minimum_implementations/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Josh</span> Peterson </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/philosophy/">philosophy </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/repositories/">repositories</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/publications/">publications</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Minimum implementations</h1> <p class="post-meta"> Created in April 04, 2017 </p> <p class="post-tags"> <a href="/blog/2017"> <i class="fa-solid fa-calendar fa-sm"></i> 2017 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>I really enjoy reading the <a href="http://graphics.stanford.edu/~seander/bithacks.html" rel="external nofollow noopener" target="_blank">Bit Twiddling Hacks</a> page. It has lots of great bit-sized (pun <em>intended</em>) algorithm implementations optimized for performance (or at least number of operations). Combine this with <a href="gcc.godbolt.org">Compiler Explorer</a>, and you’ve got hours of assembly language fun. For example, I thought it might be interesting to understand how different implementations of the <code class="language-plaintext highlighter-rouge">min</code> algorithm generate assembly code.</p> <p>Let’s look at three different implementations, all from this <a href="http://graphics.stanford.edu/~seander/bithacks.html#IntegerMinOrMax" rel="external nofollow noopener" target="_blank">section</a> of the page. You can find the code generated by GCC 6.3 <a href="https://godbolt.org/g/b6yDhD" rel="external nofollow noopener" target="_blank">here</a>.</p> <h1 id="no-branches-please">No branches, please</h1> <p>Naturally, you would expect the <code class="language-plaintext highlighter-rouge">min</code> algorithm to require at least one branch, since it is essentially an “if” check. But with some fun bitwise operations, this branch can be avoided.</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">int</span> <span class="nf">no_branch_min</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">y</span> <span class="o">^</span> <span class="p">((</span><span class="n">x</span> <span class="o">^</span> <span class="n">y</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure> <p>GCC produces this assembly (with an optimized compile), for x64:</p> <figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td> <td class="code"><pre><span class="nf">no_branch_min</span><span class="p">(</span><span class="nv">int</span><span class="p">,</span> <span class="nv">int</span><span class="p">):</span>
  <span class="nf">xor</span>     <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
  <span class="nf">cmp</span>     <span class="nb">edi</span><span class="p">,</span> <span class="nb">esi</span>
  <span class="nf">setl</span>    <span class="nb">al</span>
  <span class="nf">xor</span>     <span class="nb">edi</span><span class="p">,</span> <span class="nb">esi</span>
  <span class="nf">neg</span>     <span class="nb">eax</span>
  <span class="nf">and</span>     <span class="nb">eax</span><span class="p">,</span> <span class="nb">edi</span>
  <span class="nf">xor</span>     <span class="nb">eax</span><span class="p">,</span> <span class="nb">esi</span>
  <span class="nf">ret</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Let’s step through this code line by line to understand how the algorithm works. I’ll assume the arguments are the values 2 and 3.</p> <ul> <li>Line 1: It looks like the arguments are passed in the <code class="language-plaintext highlighter-rouge">edi</code> and <code class="language-plaintext highlighter-rouge">esi</code> registers.</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:? edi:0x00000002 esi:0x00000003 EFLAGS - SF:? OF:?</code></p> <ul> <li>Line 2: Clear the <code class="language-plaintext highlighter-rouge">eax</code> register (it will be used later).</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:0x00000000 edi:0x00000002 esi:0x00000003 EFLAGS - SF:? OF:?</code></p> <ul> <li>Line 3: The <a href="http://x86.renejeschke.de/html/file_module_x86_id_35.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">cmp</code></a> instruction subtracts the two arguments, and sets status flags, but doesn’t change any other register values. So <code class="language-plaintext highlighter-rouge">2 - 3 = -1</code>; the sign flag is set and the overflow flag is not.</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:0x00000000 edi:0x00000002 esi:0x00000003 EFLAGS - SF:1 OF:0</code></p> <ul> <li>Line 4: The <a href="http://x86.renejeschke.de/html/file_module_x86_id_308.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">setl</code></a> instruction sets its destination operand, in this case, the <code class="language-plaintext highlighter-rouge">al</code> register (the lower 16 bytes of <code class="language-plaintext highlighter-rouge">eax</code>) to a value of 1 if <code class="language-plaintext highlighter-rouge">SF != OF</code>. That is the case.</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:0x00000001 edi:0x00000002 esi:0x00000003</code></p> <ul> <li>Line 5: The <a href="http://x86.renejeschke.de/html/file_module_x86_id_330.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">xor</code></a> instruction performs an exclusive or, and puts the result in the first register.</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:0x00000001 edi:0x00000001 esi:0x00000003</code></p> <ul> <li>Line 6: The <a href="http://x86.renejeschke.de/html/file_module_x86_id_216.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">neg</code></a> instruction takes the two’s complement of its argument.</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:0xffffffff edi:0x00000001 esi:0x00000003</code></p> <ul> <li>Line 7: The logical <a href="http://x86.renejeschke.de/html/file_module_x86_id_12.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">and</code></a> instruction next stores its result in <code class="language-plaintext highlighter-rouge">eax</code>. Again, it is zero.</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:0x00000001 edi:0x00000001 esi:0x00000003</code></p> <ul> <li>Line 8: The xor instruction of 1 and 3 results in 2, which is stored in <code class="language-plaintext highlighter-rouge">eax</code> and returned.</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:0x00000002 edi:0x00000001 esi:0x00000003</code></p> <p>So as advertised, this algorithm does not take any branches, and indeed returns the minimum (at least of 2 and 3). How does it compare to the minimum algorithm in the standard library though?</p> <h1 id="using-stdmin">Using <code class="language-plaintext highlighter-rouge">std::min</code> </h1> <p>I had to do a double-take after looking at the code generated for <code class="language-plaintext highlighter-rouge">std::min</code>. Here it is, in all of its tiny glory:</p> <figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td> <td class="code"><pre><span class="nf">cmp</span>     <span class="nb">esi</span><span class="p">,</span> <span class="nb">edi</span>
<span class="nf">mov</span>     <span class="nb">eax</span><span class="p">,</span> <span class="nb">edi</span>
<span class="nf">cmovle</span>  <span class="nb">eax</span><span class="p">,</span> <span class="nb">esi</span>
<span class="nf">ret</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>That’s right, GCC compiled this minimum implementation into a real <em>minimum</em> implementation, just four instructions! Let’s understand what they are doing, again with the inputs 2 and 3.</p> <ul> <li>Line 1: The arguments are passed in the <code class="language-plaintext highlighter-rouge">edi</code> and <code class="language-plaintext highlighter-rouge">esi</code> registers. Notice that this <code class="language-plaintext highlighter-rouge">cmp</code> instruction is different from the first case, here it does <code class="language-plaintext highlighter-rouge">3 - 2 = 1</code>, so no status flags are set.</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:? edi:0x00000002 esi:0x00000003 EFLAGS - SF:0 OF:0</code></p> <ul> <li>Line 2: Via <a href="http://x86.renejeschke.de/html/file_module_x86_id_176.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">mov</code></a>, the value of 2 is copied from <code class="language-plaintext highlighter-rouge">edi</code> to <code class="language-plaintext highlighter-rouge">eax</code>. This really just sets up <code class="language-plaintext highlighter-rouge">eax</code> to be the return value of the function, it doesn’t have an impact on the algorithm.</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:0x00000002 edi:0x00000002 esi:0x00000003 EFLAGS - SF:0 OF:0</code></p> <ul> <li>Line 3: Finally, the meat of the algorithm is in <a href="http://x86.renejeschke.de/html/file_module_x86_id_34.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">cmovle</code></a>. This instruction does a <em>conditional</em> move, replacing <code class="language-plaintext highlighter-rouge">eax</code> with <code class="language-plaintext highlighter-rouge">esi</code> only if the previous <code class="language-plaintext highlighter-rouge">cmp</code> found that the left operand was less than or equal to the right operand. In other words, if the zero flag is set or the sign flag is not equal to the overflow flag. Neither condition is true in this case, so the value of 2 remains in <code class="language-plaintext highlighter-rouge">eax</code> and is returned.</li> </ul> <p><code class="language-plaintext highlighter-rouge">eax:0x00000002 edi:0x00000002 esi:0x00000003 EFLAGS - SF:0 OF:0</code></p> <p>Even in this case, there are no branches! The compiler has replaced the branch by a conditional instruction.</p> <h1 id="lets-be-naive">Let’s be naive</h1> <p>Suppose instead that I roll my own implementation of <code class="language-plaintext highlighter-rouge">min</code>, using a very clear branch:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">int</span> <span class="nf">naive_min</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure> <p>This code <em>must</em> have a branching instruction, right? Wrong!</p> <figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td> <td class="code"><pre><span class="nf">cmp</span>     <span class="nb">edi</span><span class="p">,</span> <span class="nb">esi</span>
<span class="nf">mov</span>     <span class="nb">eax</span><span class="p">,</span> <span class="nb">esi</span>
<span class="nf">cmovle</span>  <span class="nb">eax</span><span class="p">,</span> <span class="nb">edi</span>
<span class="nf">ret</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>The compiler has provided the same implementation as <code class="language-plaintext highlighter-rouge">std::min</code>. It <em>inferred</em> what I wanted to do and wrote a better implementation than I could write myself.</p> <h1 id="time-to-double-check">Time to double check</h1> <p>Look at again at the entire <a href="https://godbolt.org/g/b6yDhD" rel="external nofollow noopener" target="_blank">assembly code</a>. In the pane for compiler #2, I’ve used GCC 6.3 as well, but this time without any optimizations. Although the three different implementations generate more assembly code than the optimized compile, notice that they are still different from on another. The <code class="language-plaintext highlighter-rouge">no_branch_min</code> code does indeed have no branches, while <code class="language-plaintext highlighter-rouge">standard_min</code> and <code class="language-plaintext highlighter-rouge">naive_min</code> both have one conditional jump and one unconditional jump instruction.</p> <p>So it is true that the <code class="language-plaintext highlighter-rouge">no_branch_min</code> implementation <em>guarantees</em> no branches, but a good optimizing compiler will generate <em>better</em> code for the more human-readable <code class="language-plaintext highlighter-rouge">std::min</code> and even the naive minimum implementation.</p> <p>Let’s face it, optimizing C++ compilers are simply amazing.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/more-fun-with-loop-unrolling-cpp/">More fun with loop unrolling - C++</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/learning-loop-unrolling/">Learning loop unrolling</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/constraints-are-liberating/">Constraints are liberating</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/span-making-c-arrays-fun-since-2020/">Span - making C arrays fun since 2020</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/game-theory-fun-in-the-nfl/">Game theory fun in the NFL</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Josh Peterson. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: March 16, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>