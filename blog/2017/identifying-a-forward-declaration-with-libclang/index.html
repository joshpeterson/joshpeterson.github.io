<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Identifying a forward declaration with libclang | Josh Peterson </title> <meta name="author" content="Josh Peterson"> <meta name="description" content="Josh's personal website "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%8B&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://joshpeterson.github.io/blog/2017/identifying-a-forward-declaration-with-libclang/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Josh</span> Peterson </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/philosophy/">philosophy </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/repositories/">repositories</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/publications/">publications</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Identifying a forward declaration with libclang</h1> <p class="post-meta"> Created in January 12, 2017 </p> <p class="post-tags"> <a href="/blog/2017"> <i class="fa-solid fa-calendar fa-sm"></i> 2017 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>I’ve recently written a small utility (called <a href="https://github.com/joshpeterson/layout" rel="external nofollow noopener" target="_blank">layout</a>), which uses <a href="http://clang.llvm.org/doxygen/group__CINDEX.html" rel="external nofollow noopener" target="_blank">libclang</a> to parse C and C++ source code and determine the size, layout, and padding for all fields in all types. It generates C or C++ code which can be compiled to report this information for a specific compiler. During my first attempt, I ran into a problem detecting that a given type was a <a href="http://stackoverflow.com/a/4757718/381697" rel="external nofollow noopener" target="_blank">forward declaration</a>.</p> <h1 id="a-little-bit-about-libclang">A little bit about libclang</h1> <p>The C API for clang allows you to walk the abstract syntax tree (AST) for any C or C++ code using a visitor pattern. At each node of the AST, the visitor receives a <a href="http://clang.llvm.org/doxygen/group__CINDEX__CURSOR__MANIP.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">CXCursor</code></a> object representing that node. We can ask this cursor a number of questions, like what kind of node it is (e.g. a struct or a field) or what type it represents (e.g. <code class="language-plaintext highlighter-rouge">int</code> or <code class="language-plaintext highlighter-rouge">double</code>).</p> <p>The layout utility walks the AST, finds each class or struct, then looks for each field in that class or struct and gathers data about each field. What happens when it encounters a forward declaration like this?</p> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="nc">ForwardDeclared</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">FullType</span>
<span class="p">{</span>
  <span class="n">ForwardDeclared</span><span class="o">*</span> <span class="n">field</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure> <h1 id="the-wrong-solution">The wrong solution</h1> <p>The <a href="https://github.com/joshpeterson/layout/blob/7625a65d878a68d2ce247a7dbf8d1efad5f367d3/src/type_inspector.cpp#L40-L41" rel="external nofollow noopener" target="_blank">visitor for types</a> checks the <em>kind</em> of the cursor, and handles <code class="language-plaintext highlighter-rouge">struct</code> and <code class="language-plaintext highlighter-rouge">class</code> kinds.</p> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">auto</span> <span class="n">cursorKind</span> <span class="o">=</span> <span class="n">clang_getCursorKind</span><span class="p">(</span><span class="n">cursor</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">cursorKind</span> <span class="o">==</span> <span class="n">CXCursor_StructDecl</span> <span class="o">||</span> <span class="n">cursorKind</span> <span class="o">==</span> <span class="n">CXCursor_ClassDecl</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span></code></pre></figure> <p>However, both <code class="language-plaintext highlighter-rouge">FullType</code> and <code class="language-plaintext highlighter-rouge">ForwardDeclared</code> are <code class="language-plaintext highlighter-rouge">CXCursor_StructDecl</code> cursors, so both are handled in the same way. The resulting generated C++ code tries to call <code class="language-plaintext highlighter-rouge">sizeof(ForwardDeclared)</code>, which will cause a compiler error. Indeed, the very reason to use a forward declaration is to avoid the need for the compiler to know the size of a given type!</p> <p>My first attempt to work around this issue was to ignore any types with no fields. With this change, the output from the code generated by the utility for this case <em>seems</em> to work.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>./layout blog.cpp | g++ <span class="nt">-xc</span>++ -<span class="p">;</span> ./a.out
FullType <span class="o">(</span>8b<span class="o">)</span>:
Field |              Type | Offset | Size | Padding
field | ForwardDeclared <span class="k">*</span> |      0 |    8 |       0</code></pre></figure> <p>But suppose that I actually have a type with no fields?</p> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="nc">ForwardDeclared</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">FullType</span>
<span class="p">{</span>
  <span class="n">ForwardDeclared</span><span class="o">*</span> <span class="n">field</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">EmptyType</span>
<span class="p">{</span>
<span class="p">};</span></code></pre></figure> <p>The output for this code is the same as the code above. The type <code class="language-plaintext highlighter-rouge">EmptyType</code> is simply being skipped, which is incorrect.</p> <h1 id="a-better-solution">A better solution</h1> <p>The clang C++ API has a method named <a href="http://clang.llvm.org/doxygen/classclang_1_1TagDecl.html#afedf2ad96d0205de7428351ad61ad7ef" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">isThisDeclarationADefinition</code></a> which does exactly what we need. It will return <code class="language-plaintext highlighter-rouge">true</code> for <code class="language-plaintext highlighter-rouge">FullType</code> and <code class="language-plaintext highlighter-rouge">EmptyType</code>, but <code class="language-plaintext highlighter-rouge">false</code> for <code class="language-plaintext highlighter-rouge">ForwardDeclared</code>. Unfortunately, this method is not exposed on the C API, so the layout utility cannot use it. I started to work on exposing this method via the C API in libclang, when I stumbled across the <a href="http://clang.llvm.org/doxygen/group__CINDEX__CURSOR__XREF.html#gafcfbec461e561bf13f1e8540bbbd655b" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">clang_getCursorDefinition</code></a> method.</p> <p>I wonder what this method does when we pass it the cursor for a forward declaration. From its documentation:</p> <blockquote> <p>If given a cursor for which there is no corresponding definition, e.g., because there is no definition of that entity within this translation unit, returns a NULL cursor.</p> </blockquote> <p>We can use the <a href="http://clang.llvm.org/doxygen/group__CINDEX__CURSOR__MANIP.html#ga94d81bbf40dff4ac843458d018f3138e" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">clang_getNullCursor</code></a> method to obtain the NULL cursor value described in the documentation. Then a method to identify a forward declaration might look like this:</p> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">is_forward_declaration</span><span class="p">(</span><span class="n">CXCursor</span> <span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">clang_equalCursors</span><span class="p">(</span><span class="n">clang_getCursorDefinition</span><span class="p">(</span><span class="n">cursor</span><span class="p">),</span>
                            <span class="n">clang_getNullCursor</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure> <p>With this new method in place, we can now get better output from layout:</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>./layout blog.cpp | g++ <span class="nt">-xc</span>++ -<span class="p">;</span>./a.out
FullType <span class="o">(</span>8b<span class="o">)</span>:
Field |              Type | Offset | Size | Padding
field | ForwardDeclared <span class="k">*</span> |      0 |    8 |       0
EmptyType <span class="o">(</span>1b<span class="o">)</span>:
No fields</code></pre></figure> <p>The output now includes the <code class="language-plaintext highlighter-rouge">EmptyType</code>, and indicates its size.</p> <h1 id="update-december-7-2018">Update (December 7, 2018)</h1> <p>Astute reader Fredrik Svantesson pointed out that <code class="language-plaintext highlighter-rouge">is_forward_declaration</code> won’t work properly if the declaration and definition are in the same translation unit. In that case, <code class="language-plaintext highlighter-rouge">clang_getCursorDefinition</code> will <em>not</em> return the null cursor, but instead will return the definition cursor!</p> <p>So, we need an additional check for this case:</p> <figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">is_forward_declaration</span><span class="p">(</span><span class="n">CXCursor</span> <span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">auto</span> <span class="n">definition</span> <span class="o">=</span> <span class="n">clang_getCursorDefinition</span><span class="p">(</span><span class="n">cursor</span><span class="p">);</span>

  <span class="c1">// If the definition is null, then there is no definition in this translation</span>
  <span class="c1">// unit, so this cursor must be a forward declaration.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">clang_equalCursors</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">clang_getNullCursor</span><span class="p">()))</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

  <span class="c1">// If there is a definition, then the forward declaration and the definition</span>
  <span class="c1">// are in the same translation unit. This cursor is the forward declaration if</span>
  <span class="c1">// it is _not_ the definition.</span>
   <span class="k">return</span> <span class="o">!</span><span class="n">clang_equalCursors</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">definition</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/more-fun-with-loop-unrolling-cpp/">More fun with loop unrolling - C++</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/learning-loop-unrolling/">Learning loop unrolling</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/constraints-are-liberating/">Constraints are liberating</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/span-making-c-arrays-fun-since-2020/">Span - making C arrays fun since 2020</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/game-theory-fun-in-the-nfl/">Game theory fun in the NFL</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Josh Peterson. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: March 16, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>