<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> All your state are belong to us | Josh Peterson </title> <meta name="author" content="Josh Peterson"> <meta name="description" content="Josh's personal website "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%8B&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://joshpeterson.github.io/blog/2015/all-your-state-are-belong-to-us/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Josh</span> Peterson </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/philosophy/">philosophy </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/repositories/">repositories</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/publications/">publications</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">All your state are belong to us</h1> <p class="post-meta"> Created in April 25, 2015 </p> <p class="post-tags"> <a href="/blog/2015"> <i class="fa-solid fa-calendar fa-sm"></i> 2015 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>My colleague <a href="https://twitter.com/lucasmeijer" rel="external nofollow noopener" target="_blank">Lucas Meijer</a> was recently making changes to a rather complex bit of code in IL2CPP, the VTableBuilder class, when he tweeted this:</p> <p><img src="/static/images/all-your-state-are-belong-to-us/lucas-tweet.png" alt="A tweet about removing state"></p> <p>I added the rather unoriginal response “All your state are belong to us.”</p> <p><img src="/static/images/all-your-state-are-belong-to-us/all-your-base.png" alt="All your base are belong to us"></p> <p>This started me thinking though, could it be true that our programs have been overrun with mutable state? Is mutable state something like an invading alien army, which has taken control? The code Lucas was modifying solves a complex problem in IL2CPP (it generates a representation of the vtable for a class in managed code that is used in the native translation of the code). But is that code more complex than necessary, due to mutable state?</p> <p>More to the point, I wanted to answer the following questions:</p> <ul> <li>What is <em>problematic</em> mutable state?</li> <li>How do we correct problems with mutable state?</li> <li>Why can functional code solve the problems with mutable state?</li> </ul> <h2 id="what-is-mutable-state">What is mutable state?</h2> <p>I think that mutable state is relatively easy to define.</p> <p><strong>Mutable state</strong>: A sequence of bits stored in some type of memory (e.g. registers, non-volatile memory, volatile memory) which is written by one instruction and read by another instruction.</p> <p>Usually, we introduce mutable state with an assignment operator. For example:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">int</span> <span class="n">answer</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span> <span class="c1">// mutable state</span></code></pre></figure> <p>But all mutable state is not problematic. Variables must have some value (no pun intended), otherwise we would not use them so prevalently. Instead, we should define <em>problematic</em> mutable state.</p> <p><strong>Problematic mutable state</strong>: Mutable state which is stored at a scope too large to easily reason about.</p> <p>The problems we have with mutable state are not really about the state itself, but more so about about the state transitions. Specifically, when the value of the of the state variable changes, do we notice that change? Do we handle all of the possible values? How does the program behave when the mutable state takes on an unexpected value? By keeping the scope of the mutable state small enough for us to reason about, we can either answer or eliminate these questions.</p> <h2 id="how-do-we-correct-problems-with-mutable-state">How do we correct problems with mutable state?</h2> <p>As consumers of software, what do we usually do to correct problems with mutable state? If one of our tools, say an IDE or operating system, starts to behave badly, we restart it, right? What does restarting the software actually do? Why does it usually make the software behave correctly? By restarting it, we are actually modifying the mutable state in the program to known good values. Those values might make sense, like 0 for an integer, or NULL for a pointer. Even if they are uninitialized values, the software can deal with (or ignore) them. It was started millions of times during its development, so the value of all mutable state when the program was started can be handled correctly. Effectively, we have set the mutable state to the start of a known scope. The scope might be very large, but when the scope starts the state values are not problematic.</p> <p>As a programmer, I do the same thing. I control mutable state with various scopes, and I restart the scopes when I want to avoid the questions about mutable state (or at least, I <em>should</em> do this). For imperative programming in a object-oriented language, I think there are three levels of mutable state:</p> <ul> <li>Global or static variables</li> <li>Class or struct member variables</li> <li>Function local variables</li> </ul> <p>I’ve been taught from an early age to avoid global and static variables if at all possible. Why? In the context of this discussion, they can easily represent problematic mutable state, because their scope is the lifetime of the process. It is not possible for the programmer to restart their scope without restarting the process. For most programs and programming languages, that is not an option, as the process is the program itself.</p> <p>Class members are a bit easier to manage than global and static variables, since we have an idiom in object-oriented programming to restart their scope, the constructor. But I can still run into problems by exposing the mutable state from a class member to a larger scope. For example:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">class</span> <span class="nc">employee</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">employee</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">name_</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{}</span>

    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="n">string</span> <span class="n">name_</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure> <p>Does <code class="language-plaintext highlighter-rouge">getName</code> return a copy of the string stored in <code class="language-plaintext highlighter-rouge">name_</code>? (It does not.) What happens to the pointer returned if this instance of <code class="language-plaintext highlighter-rouge">employee</code> does out of scope? (It is a dangling reference.) These questions and many others occur because <code class="language-plaintext highlighter-rouge">name_</code> represents mutable state in the <code class="language-plaintext highlighter-rouge">employee</code> class. By exposing it publicly, I have made it problematic mutable state, because it is no longer under the control of the scope for <code class="language-plaintext highlighter-rouge">employee</code> (its constructor/destructor pair).</p> <p>Code like this is one of the reasons the <a href="http://martinfowler.com/bliki/TellDontAsk.html" rel="external nofollow noopener" target="_blank">tell, don’t ask</a> principle is sometimes useful for object-oriented programming. However, this <code class="language-plaintext highlighter-rouge">employee</code> class could have a better API, mainly because of the exposure of problematic mutable state. We could improve the API and eliminate the problematic mutable state by returning a copy of the mutable state, like this:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">class</span> <span class="nc">employee</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">employee</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">name_</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{}</span>

    <span class="n">string</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">name_</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="n">string</span> <span class="n">name_</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure> <p>Now the scope of the mutable state has changed, so that its scope is the same as the scope of the caller. The second version of this code just <em>feels</em> better. I think it is because we often have a natural tendency to avoid problematic mutable state.</p> <p>Consider a function like this:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">int</span><span class="o">&amp;</span> <span class="n">getAnswer</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">answer</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">answer</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure> <p>Immediately this function makes my skin crawl. It does the same for the compiler:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>employee.cpp:14:12: warning: reference to stack memory associated with local variable 'answer' returned [-Wreturn-stack-address]
    return answer;
           ^~~~~~
</code></pre></div></div> <p>This is a clear case of problematic mutable state, since a reference to a local variable is returned. The memory location for that reference (on the stack) can be reused after the function returns; we have no guarantee that the value in that memory location won’t change. This case of problematic mutable state is so clear, the compiler even warns us about it. But it really is similar to the first iteration of the <code class="language-plaintext highlighter-rouge">employee</code> class above. By exposing mutable state to a scope too large, we make that mutable state problematic.</p> <p>This problem is not restricted to memory access in native languages either. This C# code has a similar problem:</p> <figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">class</span> <span class="nc">employee</span> <span class="p">{</span>
  <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">titles</span><span class="p">;</span>

  <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">Titles</span> <span class="p">{</span>
    <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">titles</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="nf">employee</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">titles</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">titles</span> <span class="p">=</span> <span class="n">titles</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>By exposing a mutable collection publicly, the <code class="language-plaintext highlighter-rouge">employee</code> class here has introduced the possibility that other code could add or remove entries from that collection, thus changing the state of the collection in a way that the <code class="language-plaintext highlighter-rouge">employee</code> class does not expect. Again, this can be corrected with a better API design, as suggested by the <a href="https://msdn.microsoft.com/en-us/library/dn169389(v=vs.110).aspx" rel="external nofollow noopener" target="_blank">.NET Framework Design Guidelines</a>:</p> <ul> <li>DO NOT provide settable collection properties.</li> <li>DO use ReadOnlyCollection<t>, a subclass of ReadOnlyCollection<t>, or in rare cases IEnumerable<t> for properties or return values representing read-only collections</t></t></t> </li> </ul> <figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">class</span> <span class="nc">employee</span> <span class="p">{</span>
  <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">titles</span><span class="p">;</span>

  <span class="k">public</span> <span class="n">ReadOnlyCollection</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">Titles</span> <span class="p">{</span>
    <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="n">ReadOnlyCollection</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">titles</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="nf">employee</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">titles</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">titles</span> <span class="p">=</span> <span class="n">titles</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>All of these examples of problematic mutable state can be solved by better controlling the scope of mutable state. In this context “better” usually means:</p> <ul> <li>Make the scope of mutable state as small as possible.</li> <li>Avoid leaking the mutable state outside of that scope.</li> <li>Make a copy of the mutable state to change its scope where necessary.</li> </ul> <p>In object-oriented programming, this concept is known as <a href="http://en.wikipedia.org/wiki/Encapsulation_%28object-oriented_programming%29" rel="external nofollow noopener" target="_blank">encapsulation</a>. But in my experience, encapsulation can be difficult to get right, especially over the long lifetime of a given class. Instead, functional programming can help prevent mutable state by changing the question.</p> <h2 id="why-can-functional-code-solve-the-problems-with-mutable-state">Why can functional code solve the problems with mutable state?</h2> <p>Functional programming can solve problems with mutable state by changing the question from “How do we manage mutable state?” to “Why do we have mutable state?”. Strict functional languages like Haskell eliminate almost all mutable state, making problematic mutable state difficult to introduce. Even in C# and C++ though, we can take a functional approach by using static or free functions and avoiding static and global data.</p> <p>As long as these functions are small, we can limit the scope of the mutable state to something we can easily reason about. Once we know all of the possible values of the mutable state, and we can understand all of the code which causes transitions from one value to another, that mutable state is no longer problematic.</p> <p>Functions which affect the state of only local variables, like <a href="http://dlang.org/function.html#pure-functions" rel="external nofollow noopener" target="_blank">pure functions</a> in D, allow the compiler to have a built-in restart button. Since local variables (i.e. mutable state) are created at the start of each function and destroyed at its end, every call to a function resets the mutable state. So the same techniques for “fixing” problems with mutable state we use as consumers of software can be used as creators of software by taking a functional approach.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/more-fun-with-loop-unrolling-cpp/">More fun with loop unrolling - C++</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/learning-loop-unrolling/">Learning loop unrolling</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/constraints-are-liberating/">Constraints are liberating</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/span-making-c-arrays-fun-since-2020/">Span - making C arrays fun since 2020</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/game-theory-fun-in-the-nfl/">Game theory fun in the NFL</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Josh Peterson. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: March 16, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>