<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> A zero cost abstraction? | Josh Peterson </title> <meta name="author" content="Josh Peterson"> <meta name="description" content="Josh's personal website "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%8B&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://joshpeterson.github.io/blog/2018/a-zero-cost-abstraction/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Josh</span> Peterson </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/philosophy/">philosophy </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/repositories/">repositories</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/publications/">publications</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">A zero cost abstraction?</h1> <p class="post-meta"> Created in November 21, 2018 </p> <p class="post-tags"> <a href="/blog/2018"> <i class="fa-solid fa-calendar fa-sm"></i> 2018 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Recently Joachim (CTO at Unity) has been talking about “performance by default”, the mantra that software should be as fast as possible from the outset. This is driving the pretty cool stuff many at Unity are doing around things like ECS, the C# job system, and Burst (find lots more about that <a href="https://unity3d.com/unity/features/job-system-ECS" rel="external nofollow noopener" target="_blank">here</a>).</p> <p>One question Joachim has asked internally of Unity developers is (I’m paraphrasing here): “What is the absolute lower bound of time this code could use?” This strikes me as a really useful way to think about performance. The question changes from “How fast is this?” to “How fast could this be?”. If the answers to those two questions are not the same, the next question is “Do we <em>really</em> need the additional overhead?”</p> <p>Another way to think about this is to consider the zero-cost abstraction, a concept much discussed in the C++ and Rust communities. Programmers are always building abstractions, and those abstractions often lead to the difference between “how fast it is” and “how fast it could be”. We want to provide useful abstractions that don’t hurt performance.</p> <h2 id="reading-some-bytes">Reading some bytes</h2> <p>I was thinking about all of this recently while writing some code to read bytes from a binary file. The first bit of code that rolled off my fingers was:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">uint8_t</span> <span class="nf">ReadByte</span><span class="p">();</span>

<span class="kt">void</span> <span class="nf">ReadBytes</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadByte</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure> <p>This feels like the “canonical” way to read bytes into a buffer. The API has no abstraction - the function gets exactly what it needs: a pointer to some memory location and the number of bytes to read into that memory location.</p> <p>I ran clang-tidy on this code, and it was not happy:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>binary_reader.cpp:20:5: error: do not use pointer arithmetic
[cppcoreguidelines-pro-bounds-pointer-arithmetic,-warnings-as-errors]
    buffer[i] = ReadByte();
</code></pre></div></div> <p>At first this error was a bit confusing, but after staring at the code a bit, I think I determined why clang-tidy doesn’t like it: pointer arithmetic, while the fastest way to address a buffer, is prone to errors. Specifically, the user of this function can pass <em>any</em> value for <code class="language-plaintext highlighter-rouge">size</code>. The function has no choice but to dutifully write to memory where the client asked for it, so even a well-meaning client who passes the wrong <code class="language-plaintext highlighter-rouge">size</code> can cause memory corruption. We need an abstraction which makes this function difficult to misuse.</p> <h2 id="enter-the-span">Enter the span</h2> <p>What options do we have for an interface to <code class="language-plaintext highlighter-rouge">ReadBytes</code> that makes it easy to pass the size of the buffer correctly? Lets’ list a few</p> <ol> <li><code class="language-plaintext highlighter-rouge">ReadBytes(std::vector&lt;uint8_t&gt;&amp; buffer);</code></li> <li><code class="language-plaintext highlighter-rouge">template&lt;size_t N&gt; ReadBytes(std::array&lt;uint8_t, N&gt;&amp; buffer);</code></li> <li><code class="language-plaintext highlighter-rouge">template&lt;typename Iterator&gt; ReadBytes(Interator begin, Iterator end);</code></li> </ol> <p>All of these will work, but they seem a bit restrictive of the client in different ways. In addition, some of these APIs encode <em>more</em> information than we really need. All the client really wants to say is: “Here is a buffer I’ve set aside in memory, please fill it up with bytes, thanks!”</p> <p>Thankfully, there is an abstraction in C++20 for a collection of objects of a given type, along with their size: <a href="https://en.cppreference.com/w/cpp/container/span" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">std::span</code></a>. I’m not using C++20 for this project, but I can use the same type from the GSL, <a href="https://github.com/Microsoft/GSL/blob/master/include/gsl/span" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">gsl::span</code></a>. I wrote a bit about span’s cousin <code class="language-plaintext highlighter-rouge">gsl::multi_span</code> <a href="/using-span-with-argv">earlier</a>, learning that it has a small, non-zero cost. I wanted to dive a bit deeper with span.</p> <p>The new implementation of <code class="language-plaintext highlighter-rouge">ReadBytes</code> looks like this:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">ReadBytes</span><span class="p">(</span><span class="n">gsl</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">value</span> <span class="o">:</span> <span class="n">buffer</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">ReadByte</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure> <p>Better yet, I can call it with a number of different buffer types, all in a simple way:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="p">,</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="p">;</span>
<span class="n">ReadBytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="n">ReadBytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

<span class="kt">uint8_t</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="n">ReadBytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span></code></pre></figure> <p>For each of these cases, the compiler infers the size of the buffer, so I don’t have to make sure I pass the proper size of the buffer. Problem solved!</p> <h2 id="but-at-what-cost">But at what cost?</h2> <p>Now we have a safe API to read bytes into a buffer, and we know the baseline fastest way to read bytes into the buffer. If performance by default matters, we need to know how much we pay for this safe abstraction.</p> <p>One good way to understand the cost of code is to investigate the generated assembly code, where there is <em>very</em> little abstraction. Take a look at this <a href="https://godbolt.org/z/BdEqK5" rel="external nofollow noopener" target="_blank">comparison</a> (the first implementation is on the left, the safe one is on the right).</p> <p>The safe implementation only costs us one additional comparison instruction (line 15 on the right) at the start of the for loop. I think this is checking an error condition, so I expect most of the time this branch will not be taken. I assume the processor will notice that pretty quickly and optimize for the non-error case.</p> <p>Note that we do pay a code size price for this abstraction as well. We have five additional instructions here.</p> <p>Lets measure the run time performance cost. It looks like it will be small, but can we be sure? I wrote this benchmark:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include</span> <span class="cpf">"binary_reader.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;benchmark/benchmark.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ReadEightBytesRaw</span><span class="p">(</span><span class="n">benchmark</span><span class="o">::</span><span class="n">State</span><span class="o">&amp;</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">BinaryReader</span> <span class="n">reader</span><span class="p">(</span><span class="s">"../../../test/data/simple.wasm"</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">_</span> <span class="o">:</span> <span class="n">state</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="n">reader</span><span class="p">.</span><span class="n">ReadBytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">benchmark</span><span class="o">::</span><span class="n">DoNotOptimize</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="n">reader</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">BENCHMARK</span><span class="p">(</span><span class="n">ReadEightBytesRaw</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ReadEightBytesSpan</span><span class="p">(</span><span class="n">benchmark</span><span class="o">::</span><span class="n">State</span><span class="o">&amp;</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">BinaryReader</span> <span class="n">reader</span><span class="p">(</span><span class="s">"../../../test/data/simple.wasm"</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">_</span> <span class="o">:</span> <span class="n">state</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="n">reader</span><span class="p">.</span><span class="n">ReadBytesSpan</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="n">benchmark</span><span class="o">::</span><span class="n">DoNotOptimize</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="n">reader</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">BENCHMARK</span><span class="p">(</span><span class="n">ReadEightBytesSpan</span><span class="p">);</span></code></pre></figure> <p>And here are the results:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Running ./bench
Run on (8 X 2693.7 MHz CPU s)
CPU Caches:
L1 Data 32K (x4)
L1 Instruction 32K (x4)
L2 Unified 1024K (x4)
L3 Unified 33792K (x4)
Load Average: 0.08, 0.15, 0.13
----------------------------------------------------------
Benchmark                   Time           CPU Iterations
----------------------------------------------------------
ReadEightBytesRaw         365 ns        365 ns    1918628
ReadEightBytesSpan        364 ns        364 ns    1921003
</code></pre></div></div> <p>Although much of the time in the benchmark is used opening and seeking in the binary file, the profiler indicates the percent of time spent in the byte reading code is nearly identical, with maybe slight advantage to the raw version, which might not even be outside the margin of error.</p> <p>So using <code class="language-plaintext highlighter-rouge">span</code> as an abstraction for an arbitrary length buffer to receive data from a function provides:</p> <ol> <li>A safe interface</li> <li>A flexible interface</li> <li>No cost over the best performing case</li> </ol> <p>In this case, <code class="language-plaintext highlighter-rouge">span</code> gives us the API we want with performance by default.</p> <h2 id="update-november-24">Update (November 24)</h2> <p>Reddit user <a href="https://www.reddit.com/user/TheThiefMaster" rel="external nofollow noopener" target="_blank">u/TheThiefMaster</a> points out that GCC will <a href="https://godbolt.org/z/UrDA07" rel="external nofollow noopener" target="_blank">optimize</a> the <code class="language-plaintext highlighter-rouge">span</code> case so that the code is the same as the unsafe case, meaning it really has no overhead.</p> <p><em>Discuss this post on Reddit <a href="https://www.reddit.com/r/cpp/comments/9z2hqq/a_zero_cost_abstraction/" rel="external nofollow noopener" target="_blank">here</a>.</em></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/more-fun-with-loop-unrolling-cpp/">More fun with loop unrolling - C++</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/learning-loop-unrolling/">Learning loop unrolling</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/constraints-are-liberating/">Constraints are liberating</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/span-making-c-arrays-fun-since-2020/">Span - making C arrays fun since 2020</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/game-theory-fun-in-the-nfl/">Game theory fun in the NFL</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Josh Peterson. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: March 16, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>