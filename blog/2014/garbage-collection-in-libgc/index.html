<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Garbage collection in libgc | Josh Peterson </title> <meta name="author" content="Josh Peterson"> <meta name="description" content="Josh's personal website "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%8B&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://joshpeterson.github.io/blog/2014/garbage-collection-in-libgc/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Josh</span> Peterson </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/philosophy/">philosophy </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/repositories/">repositories</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/publications/">publications</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Garbage collection in libgc</h1> <p class="post-meta"> Created in July 16, 2014 </p> <p class="post-tags"> <a href="/blog/2014"> <i class="fa-solid fa-calendar fa-sm"></i> 2014 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>In my <a href="/reading-the-libgc-code">previous post</a> I attempted to read and understand some of the allocation code in the <a href="https://github.com/ivmai/bdwgc/" rel="external nofollow noopener" target="_blank">libgc</a> garbage collector. In this post I will attempt to understand some of the collection code.</p> <p>The libgc code is a <em>conservative</em> garbage collector. That is, it does not require the allocator, client program, or operating system do anything special to allow it to recognize pointers to objects allocated on the heap. Instead, it scans the memory and registers, looking for values that might be pointers, and attempts to reclaim unused memory. Interestingly, the libgc code provides <a href="https://github.com/ivmai/bdwgc/#general-description" rel="external nofollow noopener" target="_blank">no guarantees</a> that it will reclaim all unused memory! However, it is usually able to reclaim most, leaving the amount of memory not reclaimed bounded.</p> <h2 id="disclaimer">Disclaimer</h2> <p>The libgc code is the Boehm-Demers-Weiser conservative garbage collector for C and C++. It is used in a number of projects, including Mono and GCJ. I’m entirely new to the code base, so any conclusions I draw here could be incorrect. Please take them with a grain of salt, or, better yet, attempt to disprove them yourself. If you do, please let me know, as I am happy to learn something that I may have missed.</p> <h2 id="when-does-garbage-collection-occur">When does garbage collection occur</h2> <p>Garbage collection actually occurs during allocation. To see this, I’ll use the following test program:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#define GC_NOT_DLL
#include</span> <span class="cpf">&lt;gc.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">allocate_something</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">pointers</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">pointers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">GC_malloc</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">allocate_something</span><span class="p">();</span>
  <span class="n">allocate_something</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure> <p>We saw in the previous post that libgc makes a distinction between large and small objects. I need to allocate an object of size 2048 bytes to use the large object allocation on my 32-bit Windows 7 machine. Garbage collection is first attempted when the libgc code recognizes that it does not have enough free space to complete the requested allocation. The <code class="language-plaintext highlighter-rouge">GC_alloc_large</code> function calls <code class="language-plaintext highlighter-rouge">GC_allochblk</code> once to perform the necessary allocation. If this allocation fails, the <code class="language-plaintext highlighter-rouge">GC_collect_or_expand</code> function is called to attempt to either reclaim some unused memory or expand the pool of available memory from the OS. Once <code class="language-plaintext highlighter-rouge">GC_collect_or_expand</code> completes, <code class="language-plaintext highlighter-rouge">GC_allochblk</code> is called again.</p> <h2 id="marking-objects-that-are-in-use">Marking objects that are in use</h2> <p>The libgc code uses a marking process to determine which blocks of allocated memory are still in use, and therefore which ones can be reclaimed. A block that is probably still in use is marked and will not be reclaimed yet. The code which does the marking is in the <code class="language-plaintext highlighter-rouge">GC_mark_from</code> function in the <code class="language-plaintext highlighter-rouge">mark.c</code> file.</p> <p>Reading this function is a bit daunting, since it is rather complex. This is a quote from the comment at the top of the function:</p> <blockquote> <p>Note that this is the most performance critical routine in the collector. Hence it contains all sorts of ugly hacks to speed things up.</p> </blockquote> <p>I won’t attempt to understand the entire function. Instead, I’ll stick to the section near the <a href="https://github.com/ivmai/bdwgc/blob/master/mark.c#%20L830-L851" rel="external nofollow noopener" target="_blank">end</a> of the function which actually marks used blocks.</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td> <td class="code"><pre><span class="k">while</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">current_p</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* Empirically, unrolling this loop doesn't help a lot. */</span>
  <span class="cm">/* Since PUSH_CONTENTS expands to a lot of code,        */</span>
  <span class="cm">/* we don't.                                            */</span>
  <span class="n">current</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">word</span> <span class="o">*</span><span class="p">)</span><span class="n">current_p</span><span class="p">;</span>
  <span class="n">FIXUP_POINTER</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
  <span class="n">PREFETCH</span><span class="p">(</span><span class="n">current_p</span> <span class="o">+</span> <span class="n">PREF_DIST</span><span class="o">*</span><span class="n">CACHE_LINE_SIZE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">least_ha</span> <span class="o">&amp;&amp;</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">greatest_ha</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Prefetch the contents of the object we just pushed.  It's  */</span>
    <span class="cm">/* likely we will need them soon.                             */</span>
    <span class="n">PREFETCH</span><span class="p">((</span><span class="n">ptr_t</span><span class="p">)</span><span class="n">current</span><span class="p">);</span>
<span class="cp"># ifdef ENABLE_TRACE
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">GC_trace_addr</span> <span class="o">==</span> <span class="n">current_p</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">GC_log_printf</span><span class="p">(</span><span class="s">"GC #%u: considering(1) %p -&gt; %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                    <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">GC_gc_no</span><span class="p">,</span> <span class="n">current_p</span><span class="p">,</span> <span class="p">(</span><span class="n">ptr_t</span><span class="p">)</span><span class="n">current</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp"># endif </span><span class="cm">/* ENABLE_TRACE */</span><span class="cp">
</span>    <span class="n">PUSH_CONTENTS</span><span class="p">((</span><span class="n">ptr_t</span><span class="p">)</span><span class="n">current</span><span class="p">,</span> <span class="n">mark_stack_top</span><span class="p">,</span>
                  <span class="n">mark_stack_limit</span><span class="p">,</span> <span class="n">current_p</span><span class="p">,</span> <span class="n">exit2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">current_p</span> <span class="o">+=</span> <span class="n">ALIGNMENT</span><span class="p">;</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Sometimes I find it easier to read code from the inside out. That is, find the code which performs the action I want to understand, then follow the conditional statements which lead to that code, starting with the closest.</p> <p>In this case, I want to learn how objects that are in use are marked. The libgc code keeps track of a stack of marked objects. This code will add a block to the stop of the stack in the <code class="language-plaintext highlighter-rouge">PUSH_CONTENTS</code> macro on line 18. An object is considered in use (line 8), and is marked, if its address (represented by <code class="language-plaintext highlighter-rouge">current</code>) is between the least (<code class="language-plaintext highlighter-rouge">least_ha</code>) and greatest (<code class="language-plaintext highlighter-rouge">greatest_ha</code>) plausible heap addresses, which were computed earlier. The searching starts at <code class="language-plaintext highlighter-rouge">current_p</code> (line 1) and stops with the bound determined by <code class="language-plaintext highlighter-rouge">limit</code>.</p> <p>As the comment at the top of the function mentions, the calling code is responsible to call <code class="language-plaintext highlighter-rouge">GC_mark_from</code> for each frame on the mark stack.</p> <h2 id="reclaiming-everything-not-marked">Reclaiming everything not marked</h2> <p>After all of the allocated memory that is in use has been marked, the <code class="language-plaintext highlighter-rouge">GC_reclaim_block</code> function is called to free all blocks that are not marked via the <code class="language-plaintext highlighter-rouge">GC_freehblk</code> function. Once a block is reclaimed, it is added to the free list so that it can be used again in a subsequent allocation.</p> <h2 id="conclusion">Conclusion</h2> <p>I’ve learned a bit about the allocation and collection code in libgc. The code is rather complex and highly optimized for various compilers and platforms, so understanding even a small portion of it is difficult. The fact that it can serve as a drop-in replacement for <code class="language-plaintext highlighter-rouge">malloc</code> and <code class="language-plaintext highlighter-rouge">free</code> without placing any additional requirements on the client code or the operating system is fascinating.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/more-fun-with-loop-unrolling-cpp/">More fun with loop unrolling - C++</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/learning-loop-unrolling/">Learning loop unrolling</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/constraints-are-liberating/">Constraints are liberating</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/span-making-c-arrays-fun-since-2020/">Span - making C arrays fun since 2020</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/game-theory-fun-in-the-nfl/">Game theory fun in the NFL</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Josh Peterson. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: March 16, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>