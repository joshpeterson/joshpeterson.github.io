<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Visual Studio is busy | Josh Peterson </title> <meta name="author" content="Josh Peterson"> <meta name="description" content="Josh's personal website "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%8B&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://joshpeterson.github.io/blog/2014/visual-studio-is-busy/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Josh</span> Peterson </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/philosophy/">philosophy </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/repositories/">repositories</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/publications/">publications</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Visual Studio is busy</h1> <p class="post-meta"> Created in August 08, 2014 </p> <p class="post-tags"> <a href="/blog/2014"> <i class="fa-solid fa-calendar fa-sm"></i> 2014 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>One of the preferences in the <a href="http://unity3d.com" rel="external nofollow noopener" target="_blank">Unity</a> editor allows a user to choose which external editor should be used to open a script file. An often-up-voted <a href="http://issuetracker.unity3d.com/issues/double-clicking-a-c-number-script-will-open-monodevelop-instead-of-visual-studio" rel="external nofollow noopener" target="_blank">problem</a> on the Unity Issue Tracker occurs when some version of Visual Studio is chosen as the external editor, but Unity opens a script file in Mono Develop instead. I recently had the opportunity to investigate this problem, and I learned some interesting information about how out-of-process calls can be made to Visual Studio.</p> <h2 id="communication-via-com">Communication via COM</h2> <p>Unity communicates with Visual Studio via a COM interface named the <a href="http://msdn.microsoft.com/en-us/library/envdte.dte.aspx" rel="external nofollow noopener" target="_blank">DTE</a> interface. All methods on a COM interface return a value of type <a href="http://msdn.microsoft.com/en-us/library/bb446131.aspx" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">HRESULT</code></a>, which is a 32-bit value where each bit has a different meaning. The Windows header files define various common <code class="language-plaintext highlighter-rouge">HRESULT</code> values, like <code class="language-plaintext highlighter-rouge">S_OK</code> to indicate a successful call to the given COM method. Calls to a COM method that fail can return any one of various error values. A COM interface also allows these calls to be made from one process to another. Unity uses this aspect of the DTE interface to communicate with Visual Studio.</p> <p>The problematic error code returned by Visual Studio in this case is <code class="language-plaintext highlighter-rouge">RPC_E_CALL_REJECTED</code>, which has a hexadecimal value of 0x80010001. The value <code class="language-plaintext highlighter-rouge">RPC_E_CALL_REJECTED</code> is a rather general error code which indicates that Visual Studio cannot handle the call for some reason. This often happens because Visual Studio is busy doing something else, and it cannot service the remoted call from the DTE interface in the calling process.</p> <h2 id="solving-the-problem">Solving the problem</h2> <p>In the issue at hand, it became clear that the behavior was intermittent. Some users reported always having the problem, others say it happens half of the time a script file was opened. Still other users never experienced it at all. Users in all three groups were describing the behavior correctly! After some investigation, we learned that this problem usually occurs in two specific cases:</p> <ol> <li>A new instance of Visual Studio has been started by Unity.</li> <li>An existing instance of Visual Studio is displaying a modal dialog.</li> </ol> <h3 id="case-1-a-new-instance">Case 1: A new instance#</h3> <p>The first of these two cases is likely the most common, and is one that has been experienced in multiple versions of Unity. After starting a new instance of Visual Studio, the code in Unity had a loop that looked something like this:</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">while</span> <span class="p">(</span><span class="n">timeMs</span> <span class="o">&lt;</span> <span class="n">timeoutMs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">dte</span><span class="o">-&gt;</span><span class="n">get_MainWindow</span><span class="p">()))</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="n">Sleep</span><span class="p">(</span><span class="n">intervalMs</span><span class="p">);</span>
  <span class="n">timeMs</span> <span class="o">+=</span> <span class="n">intervalMs</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure> <p>This loop will call the <code class="language-plaintext highlighter-rouge">get_MainWindow</code> method a number of times until it finds a successful call or until <code class="language-plaintext highlighter-rouge">timeoutMs</code> time is reached. In practice, <code class="language-plaintext highlighter-rouge">timeMs</code> is five seconds, and <code class="language-plaintext highlighter-rouge">intervalMs</code> is fifty milliseconds. This code only executes when a new instance of Visual Studio is started, and its intent it to wait until <code class="language-plaintext highlighter-rouge">RPC_E_REJECTED</code> return values stop happening, indicating that Visual Studio has completed its startup and it ready to accept other calls on the DTE interface. Sometimes this worked as expected.</p> <p>Even with this code in place, the problem continued to occur for some users. After investigating a bit more, we found that the call to <code class="language-plaintext highlighter-rouge">get_MainWindow</code> can return <code class="language-plaintext highlighter-rouge">S_OK</code>, but that does not necessarily indicate that Visual Studio is ready for other DTE calls. During the startup of a new Visual Studio instance, calls to the DTE interface may be momentarily allowed, then later fail again with <code class="language-plaintext highlighter-rouge">RPC_E_CALL_REJECTED</code>. This is precisely what was happening. After getting a successful call to <code class="language-plaintext highlighter-rouge">get_MainWindow</code>, the code in Unity continued to call other DTE functions, like <code class="language-plaintext highlighter-rouge">get_ItemOperations</code> and then <code class="language-plaintext highlighter-rouge">OpenFile</code> on the <code class="language-plaintext highlighter-rouge">ItemOperations</code> object. We found that at any given time, these calls can also fail with <code class="language-plaintext highlighter-rouge">RPC_E_CALL_REJECTED</code>, even after <code class="language-plaintext highlighter-rouge">get_MainWindow</code> returned successfully!</p> <p>When one of these calls failed, the code in Unity decided to fall back to a different external code editor, which is often Mono Develop. If the script could not be opened in Mono Develop, then Unity would fall back to the editor registered with Windows to handle the script file type (e.g. .cs). This is often a different version of Visual Studio than the one selected in the Unity preferences, or maybe even Notepad.</p> <p>The newly started instance of Visual Studio, meanwhile, was often left in a very odd state. It’s process could be running, but its window may not actually be shown, so there is no clear indication that it has been started. A subsequent attempt to open a script file via Unity might then find this running instance of Visual Studio and correctly use it to open the script, leading to a behavior where Unity works correctly half of the time and fails the other half.</p> <p>The code above to wait in a <code class="language-plaintext highlighter-rouge">while</code> loop with a call to <code class="language-plaintext highlighter-rouge">Sleep</code> is not exactly pretty. I cringed the first time I saw it. I was soon re-using it though! We don’t have nearly the tools for cross-process communication that we have for cross-thread communication. So I decided to solve this problem by using this same while loop in more places where the communication between Unity and Visual Studio is likely to fail immediately after Visual Studio is started. In practice, the loop seldom iterates more than one or two times, so Unity won’t usually wait for 5 seconds. Although Visual Studio often does return <code class="language-plaintext highlighter-rouge">RPC_E_CALL_REJECTED</code> immediately after it starts, it will soon (a few milliseconds later) be ready to accept out-of-process calls on the DTE interface.</p> <h3 id="case-2-a-modal-dialog">Case 2: A modal dialog#</h3> <p>We also see Visual Studio return <code class="language-plaintext highlighter-rouge">RPC_E_CALL_REJECTED</code> when it is displaying certain modal dialogs. For example, if a Visual Studio project is modified by the user in Visual Studio and by the Unity editor (for example, when a new script is added in Unity), Visual Studio will display a dialog asking the user to either keep the changed project file or discard it in favor of the new one. Any calls made on the DTE interface while this dialog is displayed will fail with <code class="language-plaintext highlighter-rouge">RPC_E_CALL_REJECTED</code>. We have found that not all modal dialogs in Visual Studio behave this way, but some do.</p> <p>Currently, Unity does not store any state information about which Visual Studio session was last used to display a script file from Unity. Instead, Unity inspects each running Visual Studio instance and asks it (via the DTE interface) which solution file it has open. If a session of Visual Studio is displaying a modal dialog like the one described above, Unity is unable to get a proper response from the DTE interface about which solution is open. Therefore, a request by the user of Unity to open a new script file in Visual Studio can fail if Visual Studio is busy displaying a dialog.</p> <p>In this case, Unity will attempt to open a new instance of Visual Studio to display the script file. Clearly, Unity could improve its behavior in this case by keeping track of which Visual Studio instance was last used to display a given script file. However, storing that state brings along its own set of cross-process synchronization problems, since Unity must then track more information about which Visual Studio sessions are closed or crash (among other cases). Certainly, this is a direction that we might take in the future though.</p> <h2 id="conclusion">Conclusion</h2> <p>Cross-process synchronization can be difficult, especially when the code for one of the process is outside your control. Any communication with Visual Studio on the DTE interface is subject to the possibility of a <code class="language-plaintext highlighter-rouge">RPC_E_CALL_REJECTED</code> error code, so we must write the client-side code defensively, allowing for the possibility of retrying a failed call.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/more-fun-with-loop-unrolling-cpp/">More fun with loop unrolling - C++</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/learning-loop-unrolling/">Learning loop unrolling</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/constraints-are-liberating/">Constraints are liberating</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/span-making-c-arrays-fun-since-2020/">Span - making C arrays fun since 2020</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/game-theory-fun-in-the-nfl/">Game theory fun in the NFL</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Josh Peterson. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: March 16, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>